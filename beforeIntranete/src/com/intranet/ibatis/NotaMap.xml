<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nota">

	<parameterMap type="java.util.HashMap" id="notaDetail">
		<parameter property="idUsi" javaType="java.lang.Integer" />
		<parameter property="idCursi" javaType="java.lang.Integer" />
	</parameterMap>

	<select id="buscarNotas" parameterMap="notaDetail"
		resultType="com.intranet.nota.bean.NotaConNombre">
		SELECT tn.desctiponota,n.vnota,n.fecpublicado_nota
		FROM alumno al join detalle_alumnoinscripcion dai
		on al.idalumno=dai.idalumno join inscripcion i
		on dai.idinscripcion=i.idinscripcion join periodo p
		on i.idperiodo= p.idperiodo join detalle_inscricurso dic
		on i.idinscripcion=dic.idinscripcion join detalle_cursoseccion dcs
		on dic.idcursoseccion=dcs.idcursoseccion left join nota n
		on dcs.idcursoseccion=n.idcursoseccion and
		n.idinscripcion=i.idinscripcion left join detalle_tiponotacurso tnc
		on n.iddetalle_tiponotacurso=tnc.iddetalle_tiponotacurso join tiponota
		tn
		on tnc.idtiponota=tn.idtiponota
		where dcs.idcursoseccion=#{idCursi} and al.idalumno=(select alum.idalumno
		from usuario u join alumno alum
		on u.idusuario=alum.idusuario where u.idusuario=#{idUsi})
		and p.idperiodo = (select idperiodo from periodo order by idperiodo desc
		limit 1)
	</select>

	<!-- Perfil del profesor -->
	<select id="ib_buscarTipoNotas" parameterType="com.intranet.bean.Detalle_cursoSeccion"
		resultType="com.intranet.bean.Detalle_tiponotacurso">
		SELECT dtnc.*
		FROM detalle_cursoseccion dcs join curso c
		on dcs.idcurso=c.idcurso join detalle_tiponotacurso dtnc
		on c.idcurso=dtnc.idcurso join tiponota tn
		on dtnc.idtiponota=tn.idtiponota
		where dcs.idcursoseccion=#{idCursoSeccion};
	</select>

	<select id="ib_buscarAlumnosNotaConNombre" parameterType="com.intranet.bean.Detalle_cursoSeccion"
		resultType="com.intranet.nota.bean.AlumnosNotaConNombre">
		select i.idinscripcion,p.nompersona,n.vnota
		from persona p join alumno alu
		on p.idpersona=alu.idpersona join detalle_alumnoinscripcion dai
		on alu.idalumno=dai.idalumno join inscripcion i
		on dai.idinscripcion=i.idinscripcion join periodo pr
		on i.idperiodo=pr.idperiodo join detalle_inscricurso dic
		on i.idinscripcion=dic.idinscripcion join detalle_cursoseccion dcs
		on dic.idcursoseccion=dcs.idcursoseccion left join nota n
		on dcs.idcursoseccion=n.idcursoseccion and
		n.idinscripcion=i.idinscripcion
		where dcs.idcursoseccion=#{idCursoSeccion}
	</select>

	<insert id="ib_generarNota" parameterType="com.intranet.bean.Nota">
		insert into
		nota(vnota,fecPublicado_Nota,idDetalle_tiponotacurso,idInscripcion,idCursoSeccion)
		values(#{vnota},#{fecPublicado_Nota},#{idDetalle_tiponotacurso},#{idInscripcion},#{idCursoSeccion})
	</insert>

	<update id="ib_modificarNota" parameterType="com.intranet.bean.Nota">
		update nota set vnota=#{vnota}
		where idInscripcion=#{idInscripcion} and
		idDetalle_tiponotacurso=#{idDetalle_tiponotacurso} and
		idcursoseccion=#{idCursoSeccion}
	</update>

	<parameterMap type="java.util.HashMap" id="combinacionNotaXCursoDetail">
		<parameter property="vi_idInscri" javaType="java.lang.Integer" />
		<parameter property="vi_idCursi" javaType="java.lang.Integer" />
	</parameterMap>

	<select id="ib_buscarNotasDelAlumno" parameterMap="combinacionNotaXCursoDetail"
		resultType="com.intranet.nota.bean.NotaWithPorcentaje">
		SELECT n.vnota,dtnc.pesoNota
		FROM inscripcion i join periodo p
		on i.idperiodo=p.idperiodo join detalle_inscricurso dic
		on i.idinscripcion= dic.idinscripcion join detalle_cursoseccion dcs
		on dic.idcursoseccion=dcs.idcursoseccion join curso c
		on dcs.idcurso=c.idcurso join detalle_tiponotacurso dtnc
		on c.idcurso= dtnc.idcurso join nota n
		on dtnc.iddetalle_tiponotacurso=n.iddetalle_tiponotacurso and
		dcs.idcursoseccion=n.idcursoseccion and
		i.idinscripcion=n.idinscripcion
		where n.idinscripcion=#{vi_idInscri} and dcs.idcursoseccion=#{vi_idCursi}
		and p.idperiodo=(select idperiodo from periodo order by idperiodo desc
		limit 1)
	</select>

	<parameterMap type="java.util.HashMap" id="paramInscriXCursoDetail">
		<parameter property="vi_idInscri" javaType="java.lang.Integer" />
		<parameter property="vi_id" javaType="java.lang.Integer" />
		<parameter property="vi_nota" javaType="java.lang.String" />
	</parameterMap>

	<update id="ib_generarPromedioDelCursos" parameterMap="paramInscriXCursoDetail">
		update detalle_inscricurso set promedio_c=#{vi_nota}
		where idinscripcion=#{vi_idInscri} and idcursoseccion=#{vi_id}
	</update>

	<parameterMap type="java.util.HashMap" id="paramNotaGnralDetail">
		<parameter property="vi_idInscri2" javaType="java.lang.Integer" />
		<parameter property="vi_gnotal" javaType="java.lang.String" />
	</parameterMap>

	<update id="ib_generarPromedioGnral" parameterMap="paramNotaGnralDetail">
		update inscripcion set promedio_genral=#{vi_gnotal}
		where idinscripcion=#{vi_idInscri2}
	</update>

</mapper>
